<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>منصة الاختبارات - المعلم</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* --- 🎨 1. نفس نظام التصميم من واجهة الطالب --- */
    :root {
      /* Light Mode */
      --bg-color: #f0f2f5; --container-bg: rgba(255, 255, 255, 0.85); --text-color: #1c1e21; --header-color: #005a9c; --accent-color: #007bff; --accent-rgb: 0, 123, 255; --accent-glow: rgba(var(--accent-rgb), 0.5); --input-bg: #ffffff; --input-border: #ccd0d5; --item-bg: #ffffff; --item-hover-bg: #f5f5f5; --shadow-color: rgba(0, 0, 0, 0.1); --success-color: #28a745; --warning-color: #ffc107; --danger-color: #dc3545;
    }
    [data-theme="dark"] {
      /* Dark Mode */
      --bg-color: #0d1117; --container-bg: rgba(22, 27, 34, 0.8); --text-color: #c9d1d9; --header-color: #58a6ff; --accent-color: #3081f7; --accent-rgb: 48, 129, 247; --accent-glow: rgba(var(--accent-rgb), 0.5); --input-bg: #0d1117; --input-border: #30363d; --item-bg: #161b22; --item-hover-bg: #21262d; --shadow-color: rgba(0, 0, 0, 0.4); --success-color: #3fb950; --warning-color: #e3b341; --danger-color: #f85149;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: 'Cairo', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center; direction: rtl; transition: background-color 0.5s ease, color 0.5s ease; overflow: hidden; }
    body::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, var(--accent-glow) 0%, transparent 40%), radial-gradient(circle, var(--header-color) 0%, transparent 50%); background-size: 200% 200%; animation: aurora 20s linear infinite; z-index: -1; }
    @keyframes aurora { from { background-position: 0% 0%; } to { background-position: -200% -200%; } }
    .container { background: var(--container-bg); backdrop-filter: blur(15px) saturate(180%); -webkit-backdrop-filter: blur(15px) saturate(180%); padding: 30px 25px 120px 25px; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1); width: 100%; max-width: 500px; min-height: 95vh; max-height: 95vh; overflow-y: auto; box-shadow: 0 8px 32px 0 var(--shadow-color); display: flex; flex-direction: column; position: relative; }
    .header-icons { position: absolute; top: 20px; left: 25px; display: flex; gap: 15px; z-index: 100; }
    .icon-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--item-bg); border: 1px solid var(--input-border); color: var(--text-color); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; transition: all 0.3s ease; }
    .icon-btn:hover { transform: translateY(-3px) scale(1.1); color: var(--accent-color); box-shadow: 0 0 15px var(--accent-glow); }
    #theme-toggle .fa-sun { display: none; }
    #theme-toggle .fa-moon { display: block; }
    [data-theme="dark"] #theme-toggle .fa-sun { display: block; }
    [data-theme="dark"] #theme-toggle .fa-moon { display: none; }
    h1, h2, h3 { text-align: center; margin-bottom: 25px; font-weight: 700; color: var(--header-color); text-shadow: 0 0 10px var(--accent-glow); }
    h3 { font-size: 1.2rem; margin-top: 20px; }
    p { text-align: center; margin-top: 15px; font-size: 0.9rem; }
    p a { color: var(--accent-color); text-decoration: none; font-weight: 600; }
    hr { border-top: 1px solid var(--input-border); margin: 25px 0; }
    input, select, textarea { width: 100%; padding: 14px 15px; margin-bottom: 15px; border: 1px solid var(--input-border); border-radius: 10px; font-size: 1rem; font-family: 'Cairo', sans-serif; background: var(--input-bg); color: var(--text-color); transition: all 0.3s ease; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px var(--accent-glow); }
    button { width: 100%; padding: 14px 15px; margin-top: 10px; border: none; border-radius: 10px; font-size: 1.1rem; font-family: 'Cairo', sans-serif; font-weight: 700; background: linear-gradient(45deg, var(--accent-color), var(--header-color)); color: #fff; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px var(--shadow-color); }
    button:hover { transform: translateY(-3px); box-shadow: 0 6px 20px var(--accent-glow); }
    label { font-weight: 600; display: block; margin-bottom: 5px; color: var(--text-color); }
    .list-item { background: var(--item-bg); padding: 15px 20px; margin-bottom: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--input-border); box-shadow: 0 2px 5px var(--shadow-color); transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
    .list-item:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 8px 25px var(--shadow-color); }
    .list-item button { width: auto; padding: 8px 16px; font-size: 0.9rem; margin: 0; }
    section, .tab-content { animation: fadeIn 0.6s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .hidden { display: none !important; }
    .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: auto; display: flex; gap: 10px; padding: 10px; background: var(--container-bg); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border-radius: 99px; border: 1px solid var(--input-border); box-shadow: 0 8px 32px 0 var(--shadow-color); z-index: 1000; transition: bottom 0.3s ease, opacity 0.3s ease; }
    .bottom-nav.hidden { bottom: -100px; opacity: 0; }
    .nav-btn { display: flex; align-items: center; gap: 8px; padding: 10px 20px; background: transparent; border: none; color: var(--text-color); opacity: 0.7; border-radius: 99px; font-family: 'Cairo', sans-serif; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .nav-btn.active { opacity: 1; background: rgba(var(--accent-rgb), 0.15); color: var(--accent-color); box-shadow: 0 0 15px -5px var(--accent-glow); }
    .spinner { border: 4px solid var(--input-border); border-top: 4px solid var(--accent-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #image-preview-container { margin-top: 10px; text-align: center; }
    #image-preview { max-width: 100px; max-height: 100px; border-radius: 8px; border: 1px solid var(--input-border); }
    .file-input-label { background: var(--item-hover-bg); color: var(--text-color); border: 1px dashed var(--input-border); text-align: center; padding: 15px; border-radius: 10px; cursor: pointer; transition: all .3s ease; }
    .file-input-label:hover { border-color: var(--accent-color); color: var(--accent-color); }
    input[type="file"] { display: none; }
  </style>
</head>
<body data-theme="dark">

  <div class="container">
    <div class="header-icons">
      <div id="theme-toggle" class="icon-btn" title="تبديل الوضع"><i class="fas fa-sun"></i><i class="fas fa-moon"></i></div>
      <div id="logout-icon" class="icon-btn hidden" title="تسجيل الخروج"><i class="fas fa-sign-out-alt"></i></div>
    </div>
    
    <section id="register-section">
      <h1>تسجيل جديد - معلم</h1>
      <input type="text" id="register-name" placeholder="الاسم الكامل" /><input type="password" id="register-password" placeholder="كلمة المرور" /><button id="register-btn">تسجيل</button>
      <p>هل لديك حساب؟ <a href="#" id="to-login">تسجيل دخول</a></p>
    </section>

    <section id="login-section" class="hidden">
      <h1>تسجيل دخول - معلم</h1>
      <input type="text" id="login-name" placeholder="الاسم الكامل" /><input type="password" id="login-password" placeholder="كلمة المرور" /><button id="login-btn">دخول</button>
      <p>ليس لديك حساب؟ <a href="#" id="to-register">تسجيل جديد</a></p>
    </section>

    <section id="dashboard-section" class="hidden">
      <h1>مرحبًا بك، <span id="teacher-name"></span>!</h1>
      <hr />
      
      <!-- محتوى التبويبات -->
      <div id="tests-content" class="tab-content">
        <h2>اختباراتي المنشأة</h2><div id="my-tests-container"></div>
      </div>
      
      <div id="results-content" class="tab-content hidden">
        <h2>نتائج الطلاب</h2><select id="results-test-selector"></select><div id="student-results-container"></div>
      </div>

      <div id="create-test-content" class="tab-content hidden">
        <h2>إنشاء اختبار جديد</h2>
        <label for="test-name">اسم الاختبار:</label><input type="text" id="test-name" placeholder="مثال: اختبار الرياضيات" />
        <label for="test-grade">الصف:</label>
        <!-- **CORRECTION: The requested grade options are now here** -->
        <select id="test-grade">
          <option value="" disabled selected>اختر الصف</option>
          <option value="الصف الأول الإعدادي">الصف الأول الإعدادي</option>
          <option value="الصف الثاني الإعدادي">الصف الثاني الإعدادي</option>
          <option value="الصف الأول الثانوي">الصف الأول الثانوي</option>
          <option value="الصف الثاني الثانوي">الصف الثاني الثانوي</option>
          <option value="الصف الثالث الثانوي">الصف الثالث الثانوي</option>
        </select>
        <label for="test-duration">مدة الاختبار بالدقائق:</label><input type="number" id="test-duration" min="1" placeholder="مثال: 30" />
        <hr/><h3>إضافة سؤال</h3>
        <label for="question-text">نص السؤال:</label><textarea id="question-text" rows="3" placeholder="اكتب السؤال هنا..."></textarea>
        <label for="question-image-input" class="file-input-label">
            <i class="fas fa-image"></i> <span>إرفاق صورة للسؤال (اختياري)</span>
        </label>
        <input type="file" id="question-image-input" accept="image/*" />
        <div id="image-preview-container" class="hidden"><img id="image-preview" src="#" alt="معاينة الصورة" /></div>
        <label style="margin-top:15px;">خيارات الإجابة (4 خيارات):</label>
        <input type="text" class="option-input" placeholder="الخيار 1" /><input type="text" class="option-input" placeholder="الخيار 2" /><input type="text" class="option-input" placeholder="الخيار 3" /><input type="text" class="option-input" placeholder="الخيار 4" />
        <label for="correct-answer">رقم الإجابة الصحيحة (1 - 4):</label><input type="number" id="correct-answer" min="1" max="4" placeholder="مثال: 2" />
        <button id="add-question-btn" style="background: var(--accent-color);">إضافة سؤال للقائمة</button>
        <div id="questions-list-container" style="margin-top: 15px;"></div>
        <button id="save-test-btn" style="background: var(--success-color);">حفظ الاختبار</button>
      </div>
    </section>
  </div>
  
  <nav class="bottom-nav hidden" id="bottom-nav">
    <button id="nav-tests-btn" class="nav-btn active" data-target="tests-content"><i class="fas fa-file-alt"></i><span>الاختبارات</span></button>
    <button id="nav-results-btn" class="nav-btn" data-target="results-content"><i class="fas fa-poll-h"></i><span>النتائج</span></button>
    <button id="nav-create-btn" class="nav-btn" data-target="create-test-content"><i class="fas fa-plus-circle"></i><span>إنشاء</span></button>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, get } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-database.js";

    // --- Firebase Config ---
    const firebaseConfig = { apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8", authDomain: "story-97cf7.firebaseapp.com", databaseURL: "https://story-97cf7-default-rtdb.firebaseio.com", projectId: "story-97cf7", storageBucket: "story-97cf7.firebasestorage.app", messagingSenderId: "742801388214", appId: "1:742801388214:web:32a305a8057b0582c5ec17" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- DOM Elements ---
    const allSections = document.querySelectorAll('section');
    const dashboardSection = document.getElementById('dashboard-section');
    const logoutIcon = document.getElementById('logout-icon');
    const teacherNameSpan = document.getElementById("teacher-name");
    const bottomNav = document.getElementById('bottom-nav');
    const myTestsContainer = document.getElementById("my-tests-container");
    const resultsTestSelector = document.getElementById("results-test-selector");
    const studentResultsContainer = document.getElementById("student-results-container");
    const testNameInput = document.getElementById("test-name");
    const testGradeSelect = document.getElementById("test-grade");
    const testDurationInput = document.getElementById("test-duration");
    const questionText = document.getElementById("question-text");
    const optionInputs = document.querySelectorAll(".option-input");
    const correctAnswerInput = document.getElementById("correct-answer");
    const questionsListContainer = document.getElementById("questions-list-container");
    const questionImageInput = document.getElementById("question-image-input");
    const imagePreviewContainer = document.getElementById("image-preview-container");
    const imagePreview = document.getElementById("image-preview");

    // --- Variables ---
    let currentUser = null;
    let myTests = {};
    let questionsArray = [];
    let currentQuestionImageBase64 = null;

    // --- UI & Theme Functions ---
    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;
    const applyTheme = (theme) => { body.dataset.theme = theme; localStorage.setItem('theme', theme); };
    themeToggle.onclick = () => { applyTheme(body.dataset.theme === 'dark' ? 'light' : 'dark'); };
    applyTheme(localStorage.getItem('theme') || 'dark');
    function showSection(sectionToShow) { allSections.forEach(s => s.classList.add('hidden')); sectionToShow.classList.remove('hidden'); bottomNav.classList.toggle('hidden', sectionToShow.id !== 'dashboard-section'); }
    function showLoadingSpinner(container) { container.innerHTML = `<div class="spinner"></div>`; }
    const navButtons = document.querySelectorAll('.nav-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    navButtons.forEach(button => { button.addEventListener('click', () => { navButtons.forEach(btn => btn.classList.remove('active')); tabContents.forEach(content => content.classList.add('hidden')); button.classList.add('active'); document.getElementById(button.dataset.target).classList.remove('hidden'); }); });
    function setDefaultTab() { document.getElementById('nav-tests-btn').click(); }

    // --- Core Application Logic ---
    async function updateDashboard() { if (!currentUser) return; teacherNameSpan.textContent = currentUser; logoutIcon.classList.remove('hidden'); setDefaultTab(); showLoadingSpinner(myTestsContainer); const testsRef = ref(db, `tests/${currentUser}`); onValue(testsRef, (snapshot) => { myTests = snapshot.exists() ? snapshot.val() : {}; renderMyTests(); populateResultsSelector(); }); }
    function renderMyTests() { myTestsContainer.innerHTML = ""; if (Object.keys(myTests).length === 0) { myTestsContainer.innerHTML = "<p>لم تقم بإنشاء أي اختبار بعد.</p>"; return; } Object.entries(myTests).forEach(([testId, test]) => { const div = document.createElement('div'); div.className = 'list-item'; div.innerHTML = `<span>${test.name} - ${test.grade}</span><button data-testid="${testId}" class="view-results-btn">عرض النتائج</button>`; div.querySelector('.view-results-btn').onclick = () => { document.getElementById('nav-results-btn').click(); resultsTestSelector.value = testId; loadStudentResultsForTest(testId); }; myTestsContainer.appendChild(div); }); }
    function populateResultsSelector() { resultsTestSelector.innerHTML = '<option value="">اختر اختبارًا لعرض نتائجه</option>'; Object.entries(myTests).forEach(([testId, test]) => { resultsTestSelector.innerHTML += `<option value="${testId}">${test.name}</option>`; }); }
    async function loadStudentResultsForTest(testId) { if (!testId) { studentResultsContainer.innerHTML = ""; return; } showLoadingSpinner(studentResultsContainer); const resultsRef = ref(db, `results/${currentUser}/${testId}`); const snapshot = await get(resultsRef); studentResultsContainer.innerHTML = ""; if (!snapshot.exists()) { studentResultsContainer.innerHTML = "<p>لا توجد نتائج لهذا الاختبار بعد.</p>"; return; } const results = snapshot.val(); Object.entries(results).forEach(([studentName, score]) => { const div = document.createElement('div'); div.className = 'list-item'; div.innerHTML = `<span>الطالب: <strong>${studentName}</strong></span><span>الدرجة: <strong>${score}</strong></span>`; studentResultsContainer.appendChild(div); }); }
    
    // --- Image conversion logic ---
    questionImageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                currentQuestionImageBase64 = e.target.result;
                imagePreview.src = currentQuestionImageBase64;
                imagePreviewContainer.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    });

    // --- Create Test Logic ---
    function renderQuestionsList() { questionsListContainer.innerHTML = "<h3>الأسئلة المضافة:</h3>"; if(questionsArray.length === 0) { questionsListContainer.innerHTML += "<p>لم يتم إضافة أسئلة بعد.</p>"; return; } questionsArray.forEach((q, index) => { const div = document.createElement('div'); div.className = 'list-item'; div.innerHTML = `<span>${index + 1}. ${q.question} ${q.image ? '<i class="fas fa-image" style="color:var(--accent-color); margin-right: 5px;"></i>' : ''}</span><button data-index="${index}" class="remove-q-btn" style="background:var(--danger-color);">×</button>`; div.querySelector('.remove-q-btn').onclick = (e) => { questionsArray.splice(parseInt(e.target.dataset.index), 1); renderQuestionsList(); }; questionsListContainer.appendChild(div); }); }
    
    function clearQuestionForm() {
        questionText.value = "";
        optionInputs.forEach(input => input.value = "");
        correctAnswerInput.value = "";
        questionImageInput.value = "";
        imagePreviewContainer.classList.add('hidden');
        imagePreview.src = "#";
        currentQuestionImageBase64 = null;
    }
    
    document.getElementById('add-question-btn').onclick = () => {
        const question = questionText.value.trim();
        const options = Array.from(optionInputs).map(input => input.value.trim());
        const correct = parseInt(correctAnswerInput.value);
        if (!question || options.some(o => o === "") || !correct) { alert("يرجى ملء جميع حقول السؤال والخيارات والإجابة الصحيحة."); return; }
        questionsArray.push({ question, options, correct, image: currentQuestionImageBase64 });
        renderQuestionsList();
        clearQuestionForm();
    };

    document.getElementById('save-test-btn').onclick = async () => {
        const name = testNameInput.value.trim();
        const grade = testGradeSelect.value;
        const duration = testDurationInput.value.trim();
        if (!name || !grade || !duration || questionsArray.length === 0) { alert("يرجى ملء تفاصيل الاختبار وإضافة سؤال واحد على الأقل."); return; }
        const newTestRef = push(ref(db, `tests/${currentUser}`));
        await set(newTestRef, { name, grade, duration: parseInt(duration), questions: questionsArray, timestamp: Date.now() });
        alert("تم حفظ الاختبار بنجاح!");
        testNameInput.value = ""; testGradeSelect.value = ""; testDurationInput.value = "";
        questionsArray = []; renderQuestionsList();
        setDefaultTab();
    };
    
    async function saveUser(name, password) { const userRef = ref(db, `users/${name}`); if ((await get(userRef)).exists()) { alert("اسم المستخدم هذا موجود بالفعل."); return false; } await set(userRef, { password: password }); return true; }
    async function verifyUser(name, password) { const snapshot = await get(ref(db, `users/${name}`)); return snapshot.exists() && snapshot.val().password === password; }
    document.getElementById('login-btn').onclick = async () => { const name = document.getElementById("login-name").value.trim(); const password = document.getElementById("login-password").value.trim(); if (!name || !password) return alert("الرجاء تعبئة كل الحقول."); if (await verifyUser(name, password)) { currentUser = name; localStorage.setItem("loggedInTeacher", currentUser); showSection(dashboardSection); updateDashboard(); } else { alert("اسم المستخدم أو كلمة المرور غير صحيحة."); } };
    document.getElementById('register-btn').onclick = async () => { const name = document.getElementById("register-name").value.trim(); const password = document.getElementById("register-password").value.trim(); if(!name || !password) return alert("الرجاء تعبئة كل الحقول"); if (await saveUser(name, password)) { alert("تم التسجيل بنجاح! يمكنك الآن تسجيل الدخول."); showSection(document.getElementById('login-section')); } };
    logoutIcon.onclick = () => { if (confirm("هل أنت متأكد من رغبتك في تسجيل الخروج؟")) { currentUser = null; localStorage.removeItem("loggedInTeacher"); showSection(document.getElementById('login-section')); logoutIcon.classList.add('hidden'); } };
    resultsTestSelector.onchange = (e) => loadStudentResultsForTest(e.target.value);
    document.getElementById('to-login').onclick = (e) => { e.preventDefault(); showSection(document.getElementById('login-section')); };
    document.getElementById('to-register').onclick = (e) => { e.preventDefault(); showSection(document.getElementById('register-section')); };
    window.onload = () => { const savedUser = localStorage.getItem("loggedInTeacher"); if (savedUser) { currentUser = savedUser; showSection(dashboardSection); updateDashboard(); } else { showSection(document.getElementById('register-section')); } };
  </script>
</body>
</html>
